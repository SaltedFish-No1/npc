# 新增开发计划

本计划用于跟踪 NPC 后端当前迭代的主要交付项、责任拆分与验收标准，确保 Prompt 多语言、会话多角色以及文档同步三条工作流能够并行推进。

## 背景

- 角色 Prompt 需要跟随会话语言（暂支持 zh / en）动态切换，同时保持后端统一注入的参数格式。
- 新增“多 NPC 同时对话”场景，对 Session / Memory / Prompt 组合带来更复杂的上下文切换需求。
- 现有文档与 JSDoc 需反映上述调整，否则新同事很难理解模板命名约定与多角色接口。

## 近期目标

> 说明：Prompt 双语化与多 NPC 接口改造已交付，通过自测与集成测试验证，此处不再追踪。以下仅保留仍在进行的工作项。

### 文档 & JSDoc 强化
- **JSDoc**：补齐 `SessionService`, `PromptEngine`, `ChatService`, `language.ts` 中新增方法的参数/返回说明，规范参数含义（`participants`、`speakerType`、语言回退链等）。
- **Docs 站**：为多 NPC 流程、模板命名规范、新部署策略撰写独立章节；持续维护《服务架构》《API 参考》以符合最新接口。
- **部署说明**：在文档中补充 `pnpm docs:build` → `docs/.vitepress/dist` 发布步骤，帮助运维复现部署。
- **验收**：新人根据文档即可完成模板创建、多 NPC 接口调用和文档站部署，相关模块的 IDE Hover 可显示完整 JSDoc。

## 里程碑

| 时间 | 目标 | 产出 | 验收方式 |
| --- | --- | --- | --- |
| 第 3 周 | 文档与监控补齐 | VitePress 文档更新、JSDoc 完备、部署脚本 | `pnpm docs:build` 产物部署到静态站点 |

## 风险与对策

- **模板缺失**：角色未提供 zh 版本导致回复混乱 → 在激活角色时校验模板完整性，缺失时回退并告警。
- **会话切换冲突**：多 NPC 并发写入 Session → 通过数据库行级锁或版本号保障更新原子性。
- **文档滞后**：代码先行导致知识缺口 → 合并请求要求附带文档更新检查项。

## 执行指引

1. 任何 PR 涉及 Prompt/Session 逻辑，必须同步更新相关 JSDoc 与本文档状态表。
2. 每次发版前运行 `pnpm docs:build && pnpm docs:preview`，确认 `docs/.vitepress/dist` 与线上一致。
3. 运维层面按需扩容多实例，而非在单进程内贸然引入多线程，保持 IO 密集型场景的稳定性。
